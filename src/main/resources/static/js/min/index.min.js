const modalType={confirmation:0,info:1,orderList:2};var numberSongs,randomSongs,currentSong=-1,audio=document.getElementById("player");$("#document").ready(function(){reloadArraySongs(),setDataTableConfigAndEvents(),setPlaylistEvent(),setEvents()});function getTime(b){var c=Math.trunc(b/60),d=Math.round(b%60);return c+":"+(10>d?"0"+d:d)}function reloadArraySongs(){numberSongs=$("#tbodySong").find("tr[data-name]").toArray(),currentSong=-1}function updateListSong(){$.get("song/updateSongList",function(b){b.includes("<html>")?console.log("no es correcto"):($("#divListSong").html(b),$("#listPlaylist").children().removeClass("active"),$("#all").addClass("active"),setDataTableConfigAndEvents(),$("#listAddSong").hide(),$("#addSongPlaylist").hide())})}function play(){$("#play").hide(),$("#pause").show(),audio.play()}function pause(){$("#pause").hide(),$("#play").show(),audio.pause()}function loadPlaylist(b){$.ajax({type:"GET",url:"/playlist/"+b+"/songs",success:function(c){c.includes("<html>")?console.log("no es correcto"):($("#divListSong").html(c),audio.pause(),$("#player").attr("src",""),setDataTableConfigAndEvents(),reloadArraySongs(),c.includes("td")&&$("#player").trigger("ended"),0<b?ajaxSelect(b):($("#listAddSong").hide(),$("#addSongPlaylist").hide()))}})}function ajaxSelect(b){$.ajax({type:"GET",url:"/playlist/"+b+"/not-songs",success:function(c){loadSelect(c)}})}function loadSelect(b){var c=$("#listAddSong");c.html(""),0==b.length?($("#listAddSong").hide(),$("#addSongPlaylist").hide()):(c.append("<option value=\"0\"></option>"),$.each(b,function(d,f){f.status&&c.append("<option value=\""+f.id+"\">"+f.name.replace(".mp3","")+"</option>")}),$("#listAddSong").show(),$("#addSongPlaylist").show())}function setPlaylistEvent(){$("#listPlaylist").children().on("click",function(){$("#listPlaylist").children().removeClass("active"),$(this).addClass("active"),loadPlaylist($(this).data("id"))})}function setEvents(){$("#savePlaylist").on("click",function(){var b=$("#newPlaylist").val().trim();if(0!=b){var c=$("#listPlaylist").find("[data-value='"+b+"']").length;0==c?$.ajax({type:"post",url:"/playlist/addPlaylist",contentType:"application/json",data:JSON.stringify({name:b,songs:[]}),dataType:"json",success:function(d){$("#listPlaylist").append("<li class=\"list-group-item\" data-value=\""+d.name+"\" data-id=\""+d.id+"\">"+d.name+"</li>"),$("#newPlaylist").val(""),reloadArraySongs(),setPlaylistEvent()}}):console.log("ya existe")}else console.log("campo vacio")}),$("#repeatPlaylist").on("click",function(){$(this).toggleClass("active")}),$("#addSongPlaylist").on("click",function(){var b=$("#listPlaylist").find(".active").data("id"),c=$("#listAddSong").val();0!=c.length&&$.ajax({type:"POST",url:"/playlist/"+b+"/add-song",data:{song:c},success:function(d){d.includes("<html>")||($("#divListSong").html(d),setDataTableConfigAndEvents(),ajaxSelect(b),reloadArraySongs(),d.includes("td")&&0==$("#player").attr("src").length&&$("#player").trigger("ended"))},error:function(d){console.log(d)}})}),$("#player").on("ended",function(){if(!$("#repeatSong").hasClass("active"))if(!(numberSongs.length>currentSong+1))numberSongs.length==currentSong+1&&$("#repeatPlaylist").hasClass("active")&&($("#randomSong").hasClass("active")&&generateRandom(),currentSong=-1,$("#player").trigger("ended"));else if(currentSong++,!$("#randomSong").hasClass("active")){if(0!=$(numberSongs[currentSong]).find("[class='oi oi-check']").length){var b=$(numberSongs[currentSong]).data("name"),c=$(numberSongs[currentSong]).data("id");$("#player").attr("src","files/"+c),$("#currentSong").text(b),play()}else $("#player").trigger("ended");}else if(0!=$(randomSongs[currentSong]).find("[class='oi oi-check']").length){var b=$(randomSongs[currentSong]).data("name"),c=$(numberSongs[currentSong]).data("id");$("#player").attr("src","files/"+c),$("#currentSong").text(b),play()}else $("#player").trigger("ended")}),$("input[type=\"range\"]").on("input",function(){var b=($(this).val()-$(this).attr("min"))/($(this).attr("max")-$(this).attr("min"));$(this).css("background-image","-webkit-gradient(linear, left top, right top, color-stop("+b+", #6AC0F7), color-stop("+b+", #c0c0c0))")}),$("#duration").on("change",function(){audio.currentTime=$(this).val()}),$("#volume").on("input",function(){audio.volume=$(this).val()/100}),$("#player").on("durationchange",function(){var b=getTime(audio.duration);$("#totalTime").text(b),$("#duration").attr("max",audio.duration)}),$("#player").on("seeking",function(){console.log("seeking")}),$("#player").on("seeked",function(){console.log("seeked")}),$("#player").on("timeupdate",function(){var b=getTime(audio.currentTime);$("#currentTime").text(b),$("#duration").val(audio.currentTime),$("#duration").trigger("input")}),$("#play").on("click",play),$("#pause").on("click",pause)}function generateRandom(){randomSongs=[];for(var c,b=numberSongs.slice(0);0<b.length;)c=parseInt(Math.random()*b.length),randomSongs.push(b[c]),b.splice(c,1)}function setDataTableConfigAndEvents(){$("#randomSong").on("click",function(){$("#randomSong").toggleClass("active"),$("#randomSong").hasClass("active")&&generateRandom(),currentSong=-1,$("#player").trigger("ended")}),$("#tableSong").DataTable({scrollY:"251px",scrollCollapse:!1,paging:!1,ordering:!1,info:!1,dom:"<\"top\">t<\"bottom\"f>"}),$("#repeatSong").on("click",function(){$(this).toggleClass("active"),$(this).hasClass("active")?$("#player").prop("loop",!0):$("#player").prop("loop",!1)}),$("[data-function='playMusic']").on("click",function(){var b=$(this).parent(),c=b.data("id"),d=b.data("name"),f=numberSongs.indexOf(b[0]);$("#player").attr("src","files/"+c),play(),$("#currentSong").text(d),currentSong=f}),$("#file").on("change",function(){0<this.files.length&&(30>this.files.length?1e8>Object.values(this.files).map(b=>b.size).reduce((b,c)=>b+c)?$("#uploadFile").submit():(buildModal(modalType.info,"El maximo total a subir supera los 100Mb","ERROR","danger"),$("#modal").modal("toggle")):(buildModal(modalType.info,"No puede superar los 30 archivos","ERROR","danger"),$("#modal").modal("toggle")))}),$("[data-function='quitSongPlaylist']").on("click",function(){var b=$(this).parent().data("id"),c=$("#listPlaylist").find(".active").data("id");$.ajax({type:"post",url:"/playlist/"+c+"/quit-song",data:{song:b},success:function(d){if(!d.includes("<html>")){$("#divListSong").html(d);var f=currentSong,g=numberSongs[currentSong];reloadArraySongs(),currentSong=f,currentSong==numberSongs.length?(currentSong=-1,0<numberSongs.length?$("#player").trigger("ended"):(pause(),$("#player").attr("src",""),$("#currentTime").text("00:00"),$("#totalTime").text("00:00"),$("#currentSong").text(""))):$(g).data("id")==b&&(currentSong--,$("#player").trigger("ended")),ajaxSelect(c),setDataTableConfigAndEvents()}}})}),$("[data-function='deleteSong']").on("click",function(){var b=$(this).parent().data("id");buildModal(modalType.confirmation,"\xBFBorrar esta cancion?","Borrar Cancion"),$("#modal").modal("toggle"),$("#ok").on("click",function(){location.href="/song/"+b+"/delete-song"})}),$("#btnUpload1").on("click",function(){$("#labelUpload").click()}),$("#sort").on("click",function(){buildModal(modalType.orderList,"","ordenar"),$("#modal").modal("toggle"),setEventSortList(),$("#saveSort").on("click",function(){var b=$("#listPlaylist").find(".active").data("id"),c=$.map($("#sortList").find("li").toArray(),function(d){return{id:$(d).children().data("song"),sort:$(d).data("order")}});$.ajax({type:"POST",url:"playlist/"+b+"/sort-list",contentType:"application/json",data:JSON.stringify(c),success:function(d){d.includes("<html>")?console.log("no es correcto"):($("#divListSong").html(d),audio.pause(),$("#player").attr("src",""),setDataTableConfigAndEvents(),reloadArraySongs(),d.includes("td")&&$("#player").trigger("ended"),$("#modal").modal("toggle"))},error:function(d){console.log(d)}})})})}function setEventSortList(){$(".oi-arrow-top").off("click"),$(".oi-arrow-bottom").off("click"),$(".oi-arrow-top").on("click",function(){replacePosition(this,"top")}),$(".oi-arrow-bottom").on("click",function(){replacePosition(this,"bottom")})}function replacePosition(b,c){var d=$(b).parent().parent().parent().parent().parent(),f=$("#sortList").find("li[data-order='"+(d.data("order")+("bottom"==c?1:-1))+"']");f.data("order")==("bottom"==c?numberSongs.length:1)?($(b).prop("hidden",!0),f.find("bottom"==c?".oi-arrow-bottom":".oi-arrow-top").prop("hidden",!1)):d.data("order")==("bottom"==c?1:numberSongs.length)&&(d.find("bottom"==c?".oi-arrow-top":".oi-arrow-bottom").prop("hidden",!1),f.find("bottom"==c?".oi-arrow-top":".oi-arrow-bottom").prop("hidden",!0));var g=d.html();d.html(f.html()),f.html(g),setEventSortList()}function buildModal(b,c,d,f){var g="";switch(g+="<div class=\"modal-dialog modal-dialog-centered\">",g+="<div class=\"modal-content\">",b){case modalType.confirmation:g+="<div class=\"modal-header\"><h5 class=\"modal-title\">"+d+"</h5></div>",g+="<div class=\"modal-body\">"+c+"</div>",g+="<div class=\"modal-footer\">",g+="<button type=\"button\" id=\"ok\" class=\"btn btn-primary\">OK</button>",g+="<button type=\"button\" class=\"btn btn-secondary\" data-dismiss=\"modal\">Cancelar</button></div>";break;case modalType.info:g+="<div class=\"modal-header\"><h5 class=\"modal-title text-"+f+"\">"+d+"</h5></div>",g+="<div class=\"modal-body\">"+c+"</div>",g+="<div class=\"modal-footer\">",g+="<button type=\"button\" class=\"btn btn-secondary\" data-dismiss=\"modal\">OK</button></div>";break;case modalType.orderList:g+="<div class=\"modal-header\"><h5 class=\"modal-title text-"+f+"\">"+d+"</h5></div>",g+="<div class=\"modal-body\">",g+="<ul class=\"list-group\" id=\"sortList\">";for(var h=0;h<numberSongs.length;h++){g+="<li class=\"list-group-item list-group-flush\" data-order=\""+(h+1)+"\"><div data-song="+$(numberSongs[h]).data("id")+" class=\"row\">",g+="<div class=\"col-9\">"+$(numberSongs[h]).data("name").replace(".mp3","")+"</div>",g+="<div class=\"col-3\"><div class=\"row\"><div class=\"col-6\">";var j="hidden";0!=h&&(j=""),g+="<button "+j+" class=\"btn btn-sm btn-success oi oi-arrow-top\"></button>",g+="</div><div class=\"col-6\">",j="hidden",h+1!=numberSongs.length&&(j=""),g+="<button "+j+" class=\"btn btn-sm btn-success oi oi-arrow-bottom\"></button>",g+="</div></div></div></li>"}g+="</ul></div>",g+="<div class=\"modal-footer\">",g+="<button type=\"button\" id=\"saveSort\" class=\"btn btn-primary\">Guardar</button>",g+="<button type=\"button\" class=\"btn btn-secondary\" data-dismiss=\"modal\">Cancelar</button></div>";break;default:}g+="</div></div>",$("#modal").html(g)}